{
    "componentChunkName": "component---src-template-post-tsx",
    "path": "/coroutine-코루틴의-구성-요소와-원리/",
    "result": {"data":{"allMarkdownRemark":{"nodes":[{"fields":{"slug":"/coroutine-코루틴의-구성-요소와-원리/"},"timeToRead":13,"frontmatter":{"title":"[코루틴] 코루틴의 구성 요소와 원리","series":"코루틴"}},{"fields":{"slug":"/coroutine-코루틴-기초/"},"timeToRead":15,"frontmatter":{"title":"[코루틴] 코루틴 기초","series":"코루틴"}},{"fields":{"slug":"/운영체제-기초-운영체제-시작하기/"},"timeToRead":4,"frontmatter":{"title":"[운영체제 기초] 운영체제 시작하기","series":"운영체제 기초"}},{"fields":{"slug":"/컴퓨터-구조론-이론-입출력-장치/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론 이론] 입출력 장치","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/컴퓨터-구조론-이론-보조기억장치/"},"timeToRead":4,"frontmatter":{"title":"[컴퓨터 구조론 이론] 보조기억장치","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/컴퓨터-구조론-이론-메모리와-캐시-메모리/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론 이론] 메모리와 캐시 메모리","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/컴퓨터-구조론-이론-CPU의-성능-향상-기법/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론 이론] CPU의 성능 향상 기법","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/advanced-kotlin-코틀린을-더-알아보자/"},"timeToRead":11,"frontmatter":{"title":"[코틀린 고급] 코틀린을 더 알아보자!","series":"코틀린 고급"}},{"fields":{"slug":"/컴퓨터-구조론-이론-CPU의-작동-원리/"},"timeToRead":6,"frontmatter":{"title":"[컴퓨터 구조론 이론] CPU의 작동 원리","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/advanced-kotlin-어노테이션과-리플렉션/"},"timeToRead":8,"frontmatter":{"title":"[코틀린 고급] 어노테이션과 리플렉션","series":"코틀린 고급"}},{"fields":{"slug":"/advanced-kotlin-연산자-오버로딩과-Kotlin-DSL/"},"timeToRead":12,"frontmatter":{"title":"[코틀린 고급] 연산자 오버로딩과 Kotlin DSL","series":"코틀린 고급"}},{"fields":{"slug":"/컴퓨터-구조론-이론-명령어/"},"timeToRead":6,"frontmatter":{"title":"[컴퓨터 구조론 이론] 명령어","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/컴퓨터-구조론-이론-데이터/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론 이론] 데이터","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/코틀린-K2-컴파일러/"},"timeToRead":11,"frontmatter":{"title":"Kotlin 1.x에서 안 되던 코드가 2.0에서 된다? — K2 컴파일러가 바꿔놓은 Java SAM 변환의 모든 것","series":"트러블 슈팅"}},{"fields":{"slug":"/advanced-kotlin-복잡한-함수형-프로그래밍/"},"timeToRead":12,"frontmatter":{"title":"[코틀린 고급] 복잡한 함수형 프로그래밍","series":"코틀린 고급"}},{"fields":{"slug":"/advanced-kotlin-지연과-위임/"},"timeToRead":18,"frontmatter":{"title":"[코틀린 고급] 지연과 위임","series":"코틀린 고급"}},{"fields":{"slug":"/컴퓨터-구조론-이론-컴퓨터-구조-시작하기/"},"timeToRead":4,"frontmatter":{"title":"[컴퓨터 구조론 이론] 컴퓨터 구조 시작하기","series":"컴퓨터 구조론 이론"}},{"fields":{"slug":"/advanced-kotlin-제네릭/"},"timeToRead":18,"frontmatter":{"title":"[코틀린 고급] 제네릭","series":"코틀린 고급"}},{"fields":{"slug":"/컴퓨터-구조론-마무리/"},"timeToRead":2,"frontmatter":{"title":"[컴퓨터 구조론] 마무리","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-기계어-어셈블리어/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론] 기계어와 어셈블리어","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-CPU-만들기-제어장치/"},"timeToRead":9,"frontmatter":{"title":"[컴퓨터 구조론] CPU 만들기 - 제어장치","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-제어장치가-없는-컴퓨터/"},"timeToRead":3,"frontmatter":{"title":"[컴퓨터 구조론] 제어장치가 없는 컴퓨터","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-메모리-만들기/"},"timeToRead":12,"frontmatter":{"title":"[컴퓨터 구조론] 메모리 만들기","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-CPU-만들기/"},"timeToRead":4,"frontmatter":{"title":"[컴퓨터 구조론] CPU 만들기: 산술논리연산장치(ALU)","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-컴퓨터-기초가-되는-하드웨어-만들기/"},"timeToRead":13,"frontmatter":{"title":"[컴퓨터 구조론] 컴퓨터의 기초가 되는 하드웨어 만들기","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-비트/"},"timeToRead":7,"frontmatter":{"title":"[컴퓨터 구조론] 비트","series":"컴퓨터 구조론"}},{"fields":{"slug":"/Redis-캐싱-전략/"},"timeToRead":4,"frontmatter":{"title":"[Redis] Redis 캐싱 전략","series":"redis 기본"}},{"fields":{"slug":"/Redis-사용법-익히기/"},"timeToRead":4,"frontmatter":{"title":"[Redis] Redis 사용법 익히기","series":"redis 기본"}},{"fields":{"slug":"/Redis-기본-개념/"},"timeToRead":1,"frontmatter":{"title":"[Redis] Redis 기본 개념","series":"redis 기본"}},{"fields":{"slug":"/Gradle-Introduction/"},"timeToRead":2,"frontmatter":{"title":"[Gradle] Introduction","series":"gradle"}},{"fields":{"slug":"/intellij-플러그인/"},"timeToRead":2,"frontmatter":{"title":"[IntelliJ] 플러그인","series":"IntelliJ"}},{"fields":{"slug":"/intellij-Git-Github/"},"timeToRead":4,"frontmatter":{"title":"[IntelliJ] Git&Github","series":"IntelliJ"}},{"fields":{"slug":"/intellij-디버깅/"},"timeToRead":3,"frontmatter":{"title":"[IntelliJ] 디버깅","series":"IntelliJ"}},{"fields":{"slug":"/intellij-리팩토링/"},"timeToRead":6,"frontmatter":{"title":"[IntelliJ] 리팩토링","series":"IntelliJ"}},{"fields":{"slug":"/intellij-자동완성/"},"timeToRead":3,"frontmatter":{"title":"[IntelliJ] 자동완성","series":"IntelliJ"}},{"fields":{"slug":"/intellij-검색/"},"timeToRead":4,"frontmatter":{"title":"[IntelliJ] 검색","series":"IntelliJ"}},{"fields":{"slug":"/css/"},"timeToRead":8,"frontmatter":{"title":"[프론트엔드] css","series":"프론트엔드"}},{"fields":{"slug":"/Javascript/"},"timeToRead":18,"frontmatter":{"title":"[프론트엔드] Javascript","series":"프론트엔드"}},{"fields":{"slug":"/HTML/"},"timeToRead":10,"frontmatter":{"title":"[프론트엔드] HTML","series":"프론트엔드"}},{"fields":{"slug":"/프론트엔드에-대해/"},"timeToRead":6,"frontmatter":{"title":"[프론트엔드] 프론트엔드에 대해","series":"프론트엔드"}},{"fields":{"slug":"/백엔드-개발자에-의한-백엔드-개발자를-위한-프론트엔드/"},"timeToRead":2,"frontmatter":{"title":"[프론트엔드] 백엔드 개발자에 의한, 백엔드 개발자를 위한 프론트엔드","series":"프론트엔드"}},{"fields":{"slug":"/intellij-포커스/"},"timeToRead":3,"frontmatter":{"title":"[IntelliJ] 포커스","series":"IntelliJ"}},{"fields":{"slug":"/intellij-코드-Edit/"},"timeToRead":8,"frontmatter":{"title":"[IntelliJ] 코드 Edit","series":"IntelliJ"}},{"fields":{"slug":"/intellij-소개/"},"timeToRead":3,"frontmatter":{"title":"[IntelliJ] 소개","series":"IntelliJ"}},{"fields":{"slug":"/컴퓨터-구조론-불-대수/"},"timeToRead":13,"frontmatter":{"title":"[컴퓨터 구조론] 불 대수","series":"컴퓨터 구조론"}},{"fields":{"slug":"/지속-성장-가능한-소프트웨어를-만들어가는-방법/"},"timeToRead":7,"frontmatter":{"title":"[소프트웨어] 지속 성장 가능한 소프트웨어를 만들어가는 방법","series":"소프트웨어"}},{"fields":{"slug":"/향로와-함께하는-챌린지-후기/"},"timeToRead":2,"frontmatter":{"title":"향로와 함께하는 추석 완강 챌린지","series":"일상"}},{"fields":{"slug":"/컴퓨터-구조론-컴퓨터-구성-요소/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론] 컴퓨터 구성 요소","series":"컴퓨터 구조론"}},{"fields":{"slug":"/컴퓨터-구조론-컴퓨터-구조-개요/"},"timeToRead":5,"frontmatter":{"title":"[컴퓨터 구조론] 컴퓨터 구조 개요","series":"컴퓨터 구조론"}},{"fields":{"slug":"/java-to-kotlin-starter-guide-추가적으로-알아두어야-할-코틀린-특성/"},"timeToRead":8,"frontmatter":{"title":"[코틀린 입문] 추가적으로 알아두어야 할 코틀린 특성","series":"코틀린 입문"}},{"fields":{"slug":"/java-to-kotlin-starter-guide-코틀린에서-FP/"},"timeToRead":16,"frontmatter":{"title":"[코틀린 입문] 코틀린에서 FP","series":"코틀린 입문"}},{"fields":{"slug":"/컴퓨터-기초-자료구조-소개와-마무리/"},"timeToRead":2,"frontmatter":{"title":"[컴퓨터 기초] 자료구조 소개와 마무리","series":"컴퓨터 기초"}},{"fields":{"slug":"/컴퓨터-기초-프로그래밍-맛보기/"},"timeToRead":4,"frontmatter":{"title":"[컴퓨터 기초] 프로그래밍 맛보기","series":"컴퓨터 기초"}},{"fields":{"slug":"/코틀린-상속-간-주의-점/"},"timeToRead":2,"frontmatter":{"title":"코틀린 상속 간 주의점","series":"트러블 슈팅"}},{"fields":{"slug":"/java-to-kotlin-starter-guide-코틀린에서-OOP/"},"timeToRead":23,"frontmatter":{"title":"[코틀린 입문] 코틀린에서 OOP","series":"코틀린 입문"}},{"fields":{"slug":"/컴퓨터-기초-넓고-얕은-운영체제/"},"timeToRead":8,"frontmatter":{"title":"[컴퓨터 기초] 넓고 얕은 운영체제","series":"컴퓨터 기초"}},{"fields":{"slug":"/java-to-kotlin-starter-guide-코틀린에서-코드를-제어하는-방법/"},"timeToRead":13,"frontmatter":{"title":"[코틀린 입문] 코틀린에서 코드를 제어하는 방법","series":"코틀린 입문"}},{"fields":{"slug":"/컴퓨터-기초-넓고-얕은-컴퓨터-구조/"},"timeToRead":7,"frontmatter":{"title":"[컴퓨터 기초] 넓고 얕은 컴퓨터 구조","series":"컴퓨터 기초"}},{"fields":{"slug":"/컴퓨터-기초-컴공-이론을-위한-기초체력-다지기/"},"timeToRead":7,"frontmatter":{"title":"[컴퓨터 기초] 컴공 이론을 위한 기초체력 다지기","series":"컴퓨터 기초"}},{"fields":{"slug":"/java-to-kotlin-starter-guide-코틀린에서-변수와-타입-연산자를-다루는-방법/"},"timeToRead":14,"frontmatter":{"title":"[코틀린 입문] 코틀린에서 변수와 타입, 연산자를 다루는 방법","series":"코틀린 입문"}},{"fields":{"slug":"/java-to-kotlin-starter-guide-강의-소개/"},"timeToRead":2,"frontmatter":{"title":"[코틀린 입문] 강의 소개","series":"코틀린 입문"}},{"fields":{"slug":"/컴퓨터-기초-학습에-앞서-본-강의-소개/"},"timeToRead":3,"frontmatter":{"title":"[컴퓨터 기초] 학습에 앞서 본 강의 소개","series":"컴퓨터 기초"}},{"fields":{"slug":"/중요한-것은-포기하지-않는-마음/"},"timeToRead":3,"frontmatter":{"title":"2025년 1분기 회고(feat. 중요한 것은 포기하지 않는 마음)","series":"일상 이야기"}},{"fields":{"slug":"/2024년-주니어-개발자-회고록/"},"timeToRead":3,"frontmatter":{"title":"2024년 주니어 개발자 회고록","series":"일상 이야기"}},{"fields":{"slug":"/WDD/"},"timeToRead":1,"frontmatter":{"title":"WDD(Why-Driven-Development)","series":"생각정리"}},{"fields":{"slug":"/내가-개발자-커리어를-시작한-이유/"},"timeToRead":4,"frontmatter":{"title":"내가 개발자 커리어를 시작한 이유","series":"일상"}},{"fields":{"slug":"/블로그-이관-및-회고/"},"timeToRead":3,"frontmatter":{"title":"블로그 이관 및 회고","series":"일상 이야기"}},{"fields":{"slug":"/Spring-Boot-3.2.x-더-이상-바이트코드를-구문-분석하여-매개변수-이름을-추론하려고-시도하지-않스/"},"timeToRead":3,"frontmatter":{"title":"Spring Boot 3.2.x 더 이상 바이트코드를 구문 분석하여 매개변수 이름을 추론하려고 시도하지 않습니다.","series":"트러블 슈팅"}},{"fields":{"slug":"/라떼-개발자/"},"timeToRead":2,"frontmatter":{"title":"라떼 개발자","series":"생각정리"}},{"fields":{"slug":"/2023년-주니어-개발자-회고록/"},"timeToRead":5,"frontmatter":{"title":"2023년 주니어 개발자 회고록","series":"일상 이야기"}}],"group":[{"fieldValue":"IntelliJ","totalCount":9},{"fieldValue":"gradle","totalCount":1},{"fieldValue":"redis 기본","totalCount":3},{"fieldValue":"생각정리","totalCount":2},{"fieldValue":"소프트웨어","totalCount":1},{"fieldValue":"운영체제 기초","totalCount":1},{"fieldValue":"일상","totalCount":2},{"fieldValue":"일상 이야기","totalCount":4},{"fieldValue":"컴퓨터 구조론","totalCount":11},{"fieldValue":"컴퓨터 구조론 이론","totalCount":8},{"fieldValue":"컴퓨터 기초","totalCount":6},{"fieldValue":"코루틴","totalCount":2},{"fieldValue":"코틀린 고급","totalCount":6},{"fieldValue":"코틀린 입문","totalCount":6},{"fieldValue":"트러블 슈팅","totalCount":3},{"fieldValue":"프론트엔드","totalCount":5}]},"markdownRemark":{"id":"9278103d-270c-5d9a-8ef0-77c4b0209efb","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0klEQVQoz2NY5bPjPzUxAzGKVnpvx8vHaSCKQl9MvNJrOxjDxbAYzoBu2AqPbf+Xu2/7v8xlKwS7gugtYPZq/51gvMx5y/+lzlv+r/DchmEoigtBBm1LPfT/aOu5/6cnXf5/ovvi/zOTr/w/2X8JzL84/yYYn5505f/5Wdf/b08/BHYAdi/7QgzcnnH4//GuC//Pz77+/3j3xf+nJ1/5f2HOdTAGiZ+ddhUsBjJ4S+IB3AaieNkN6k1XZC9vgYi7QoKCKC8TihQMjC9S6JoOSTEQAN1mISBmM6oCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"banner\"\n        title=\"banner\"\n        src=\"/static/04341d4252ddede34778002280a915f7/8c557/banner.png\"\n        srcset=\"/static/04341d4252ddede34778002280a915f7/6f3f2/banner.png 256w,\n/static/04341d4252ddede34778002280a915f7/01e7c/banner.png 512w,\n/static/04341d4252ddede34778002280a915f7/8c557/banner.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>해당 포스팅은 인프런의 <a href=\"https://inf.run/Rm45L\">2시간으로 끝내는 코루틴</a> 강의를 참조하여 작성한 글입니다.</p>\n</blockquote>\n<h2>Structured Concurrency</h2>\n<p>코루틴이 나타내는 Job의 life cycle에 대해 살펴보자. 코루틴이 생성되면 <code>NEW</code>상태가 되었다가 활성화되면 <code>ACTIVE</code>상태가 된다. 그러다가 예외가 되면 <code>CANCELING</code> 상태가 되었다가 <code>CANCELED</code> 상태로 돌아가며 만약 성공한다면 <code>COMPLETING</code> 상태가 되었다가 <code>COMPLETED</code>로 간다. 이때 주어진 작업이 완료된 코루틴은 <code>COMPLETED</code> 상태가 되는 것이 아니라 <code>COMPLETING</code> 상태로 처리되었다. 작업이 완료된 경우 <code>COMPLETED</code>가 되는 것이 아니라 왜 한 단계를 거쳐갈까?</p>\n<p>그 이유는 자식 코루틴이 있을 경우, 자식 코루틴들이 모두 완료될 때까지 기다릴 수 있고, 자식 코루틴들 중 하나에서 예외가 발생하면 다른 자식 코루틴들에게도 취소 요청을 보내기 때문이다. 아래의 코드를 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> me<span class=\"token punctuation\">.</span>sungbin<span class=\"token punctuation\">.</span>coroutine\n\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>delay\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>launch\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>runBlocking\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Unit <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n    launch <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">600L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"A\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    launch <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token function\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"코루틴 실패!\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이 코드에서는 첫 번째 코루틴이 A를 출력하고 있고, 두 번째 코루틴이 예외를 던지고 있다. 두 코루틴은 독립적이기 때문에 예외도 발생하고 A도 출력될 것 같지만, 실제로는 예외만 발생되는 것을 확인할 수 있다. 그 이유는, 두 번째 코루틴에서 발생한 예외가 <code>runBlocking</code>에 의해 만들어진 부모 코루틴에게 취소 신호를 보내게 되고, 이 취소 신호를 받은 부모 코루틴이 다른 자식 코루틴인 첫 번째 코루틴까지 취소시키기 때문이다. 이렇게 부모 - 자식 관계의 코루틴이 한 몸 처럼 움직이는 것을 “Structured Concurrency”라고 부른다.</p>\n<p>코틀린 공식 문서에서는 Structured Concurrency에 대해 다음과 같이 이야기하고 있다.</p>\n<ul>\n<li>Structured Concurrency는 수많은 코루틴이 유실되거나 누수되지 않도록 보장한다.</li>\n<li>Structured Concurrency는 코드 내의 에러가 유실되지 않고 적절히 보고될 수 있도록 보장한다.</li>\n</ul>\n<p>그럼 내용을 정리해보자.</p>\n<ul>\n<li>자식 코루틴에서 예외가 발생할 경우, Structured Concurrency에 의해 부모 코루틴이 취소되고, 부모 코루틴의 다른 자식 코루틴들도 취소된다.</li>\n<li>자식 코루틴에서 예외가 발생하지 않더라도 부모 코루틴이 취소되면, 자식 코루틴들이 취소된다.</li>\n<li>다만 <code>CancellationException</code>의 경우 정상적인 취소로 간주하기 때문에 부모 코루틴에게 전파되지 않고, 부모 코루틴의 다른 자식 코루틴을 취소시키지도 않는다.</li>\n</ul>\n<h2>CoroutineScope과 CoroutineContext</h2>\n<p>이번에는 <code>CoroutineScope</code>과 <code>CoroutineContext</code>에 대해 알아보자. 사실 <code>CoroutineScope</code>은 사용해본 경험이 존재한다. 바로 root 코루틴을 만들기 위해서, 새로운 영역을 만든 후 <code>launch</code>를 이용해 코루틴을 만들었던 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">lec0701</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> job <span class=\"token operator\">=</span> <span class=\"token function\">CoroutineScope</span><span class=\"token punctuation\">(</span>Dispatchers<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Job 1\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    job<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>그렇다면, 이 <code>CoroutineScope</code>은 도대체 무엇일까? 사실 우리가 사용했던 <code>launch</code> 혹은 <code>async</code>와 같은 코루틴 빌더는 <code>CoroutineScope</code>의 확장함수이다. 즉, <code>launch</code>와 <code>async</code>를 사용하려면 <code>CoroutineScope</code>이 필요했던 것이다. 때문에 지금까지 사실은 <code>runBlocking</code>이 코루틴과 루틴의 세계를 이어주며, <code>CoroutineScope</code>를 제공해주었고, <code>runBlocking</code> 안에서 <code>launch</code>와 <code>async</code>를 사용했었다. 만약 우리가 직접 <code>CoroutineScope</code>을 만든다면 <code>runBlocking</code>이 굳이 필요하지 않다. main 함수를 일반 함수로 만들어 코루틴이 끝날 때까지 main 스레드를 대기시킬 수도 있고, main 함수 자체를 <code>suspend</code> 함수로 만들어 <code>join()</code> 시킬 수도 있다.</p>\n<p>이 <code>CoroutineScope</code>의 주요 역할은 <code>CoroutineContext</code>라는 데이터를 보관하는 것이다. 실제 <code>CoroutineScope</code> 인터페이스 역시 매우 단순하다. <code>CoroutineContext</code>는 코루틴과 관련된 여러가지 데이터를 갖고 있다. 예를 들어 이 Context 안에는 현재 코루틴의 이름도 들어 있고, 우리가 살펴보았던 <code>CoroutineExceptionHandler</code>가 있을 수도 있으며, 코루틴의 Job 자체도 들어 있고, 우리가 <code>CoroutineScope</code>을 만들 때 넣어주었던 <code>CoroutineDispatcher</code>도 들어 있다. Dispatcher는 코루틴이 어떤 스레드에 배정될지를 관리하는 역할을 맡는다.</p>\n<p>지금까지 내용을 정리해보면, <code>CoroutineScope</code>은 코루틴이 탄생할 수 있는 영역이고, <code>CoroutineScope</code> 안에는 <code>CoroutineContext</code>라는 코루틴과 관련된 데이터가 들어 있다. 우리가 부모 코루틴과 자식 코루틴이라고 불렀던 것도 한 영역 안에서 코루틴이 생기는것을 의미하는데 한번 자세히 살펴보자.</p>\n<p>최초 한 영역에 부모 코루틴이 있다고 하자. 이때 <code>CoroutineContext</code>에는 이름, <code>Dispatchers.Default</code>, 부모 코루틴이 들어 있다. 이 상황에서 부모 코루틴에서 자식 코루틴을 만든다. 그럼 자식 코루틴은 부모 코루틴과 같은 영역에서 생성되고, 생성될 때 이 영역의 context를 가져온 다음 필요한 정보를 덮어 써 새로운 context를 만든다. 예를 들어 이름을 우리가 직접 지정해주었다고 하자. 그럼 자식 코루틴은 우리가 지정해준 이름을 이용해 필요한 데이터를 context에서 가져와 적절히 덮어 쓰고 새로운 context를 갖게 된다. 이 과정에서 부모 - 자식 간의 관계도 설정해준다. 이 원리가 바로 Structured Concurrency를 작동시킬 수 있는 기반이 된다.</p>\n<p>그리고 이렇게 한 영역에 있는 코루틴들은 영역 자체를 <code>cancel()</code> 시킴으로써 모든 코루틴을 종료시킬 수 있다. 예를 들어 다음 코드처럼 클래스 내부에서 독립적인 <code>CoroutineScope</code>을 관리한다면, 해당 클래스에서 사용하던 코루틴을 한 번에 종료시킬 수 있게 된다. 아래의 코드를 보면 이해가 될 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> me<span class=\"token punctuation\">.</span>sungbin<span class=\"token punctuation\">.</span>coroutine\n\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>CoroutineScope\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>Dispatchers\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>cancel\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>launch\n\n<span class=\"token keyword\">class</span> AsyncLogic <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> scope <span class=\"token operator\">=</span> <span class=\"token function\">CoroutineScope</span><span class=\"token punctuation\">(</span>Dispatchers<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        scope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 무언가 코루틴이 시작되어 작업</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        scope<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이제 <code>CoroutineContext</code>에 대해 조금 더 자세히 살펴보자. <code>CoroutineContext</code>는 <code>Map</code>과 <code>Set</code>을 섞어 둔 자료구조와 같다. <code>CoroutineContext</code>에 저장되는 데이터는 <code>key - value</code>로 이루어져 있고, <code>Set</code>과 비슷하게 동일한 <code>Key</code>를 가진 데이터는 하나만 존재할 수 있다. 이 key - value 하나하나를 Element라 부르고, + 기호를 이용해 각 Element를 합치거나 context에 Element를 추가할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token comment\">// + 기호를 이용한 Element 합성</span>\n<span class=\"token function\">CoroutineName</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"나만의 코루틴\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">SupervisorJob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// context에 Element를 추가</span>\ncoroutineContext <span class=\"token operator\">+</span> <span class=\"token function\">CoroutineName</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"나만의 코루틴\"</span></span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>만약 context에서 Element를 제거하고 싶다면, <code>minusKey</code> 함수를 이용해 제거할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\">coroutineContext<span class=\"token punctuation\">.</span><span class=\"token function\">minusKey</span><span class=\"token punctuation\">(</span>CoroutineName<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>마지막으로 context에 들어갈 수 있는 <code>Dispatcher</code>에 대해 조금 더 자세히 살펴보자. 코루틴이 스레드에 배정되어 실행된다고 살펴보았다. 또한 코루틴은 중단되었다가 다른 스레드에 배정될 수도 있는데, 이렇게 코루틴을 스레드에 배정하는 역할을 <code>Dispatcher</code>가 수행한다. Dispatcher의 대표적인 종류는 다음과 같다.</p>\n<ul>\n<li>Dispatchers.Default\n<ul>\n<li>가장 기본적인 디스패쳐. CPU 자원을 많이 쓸 때 권장되며 별 다른 설정이 없다면 <code>Dispatchers.Default</code>가 사용된다.</li>\n</ul>\n</li>\n<li>Dispatchers.IO\n<ul>\n<li>I/O 작업에 최적화된 디스패처.</li>\n</ul>\n</li>\n<li>Dispatchers.Main\n<ul>\n<li>보통 UI 컴포넌트를 조작하기 위한 디스패처. 특정 의존성을 가지고 있어야 정상적으로 활용할 수 있다.</li>\n</ul>\n</li>\n<li>Java의 스레드풀인 ExecutorService를 디스패처로 변환\n<ul>\n<li><code>asCoroutineDispatcher()</code>이라는 확장함수를 이용해 <code>ExecutorService</code>를 디스패처로 전환할 수 있다.</li>\n</ul>\n</li>\n</ul>\n<h2>suspending function</h2>\n<p>이번에는 suspending function과 scoping function에 대해 알아보자.</p>\n<p>먼저, suspending function이란 우리가 지금까지 사용해왔던 것으로 suspend 지시어가 붙은 함수를 의미한다. 이렇게 들으면 굉장히 간단한데 suspend 지시어가 붙으면 무엇이 달라지는 것일까? 바로 suspend 함수를 부를 수 있는 능력이 생긴다. 그런데 가만히 생각해보면 우리는 main함수에서 suspend 함수를 불러도 큰 문제가 안 생겼다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Unit <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n    launch <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이 코드는 어떻게 가능한 것일까? 사실 우리가 사용한 runBlocking 코루틴 빌더나 launch 코루틴 빌더에서 다른 함수를 받을 때, 이 함수는 suspend 함수로 간주된다. 실제 launch의 시그니처에서도 suspend 함수를 받고 있다. 이렇게 함수 타입에 suspend를 붙인 것을 가리켜 <code>suspending lambda</code>라고 부른다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token comment\">// launch의 시그니처, suspend 함수를 받고 있다.</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">fun</span> CoroutineScope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span>\n    context<span class=\"token operator\">:</span> CoroutineContext <span class=\"token operator\">=</span> EmptyCoroutineContext<span class=\"token punctuation\">,</span>\n    start<span class=\"token operator\">:</span> CoroutineStart <span class=\"token operator\">=</span> CoroutineStart<span class=\"token punctuation\">.</span>DEFAULT<span class=\"token punctuation\">,</span>\n    block<span class=\"token operator\">:</span> <span class=\"token keyword\">suspend</span> CoroutineScope<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Job</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>suspend 함수에서 또 다른 suspend 함수를 호출할 수 있다는 것을 알았다. 그 외에 또 다른 의미는 없을까? “suspend”라는 단어의 뜻을 사전에서 찾아보면, 정지 / 중지 / 유예와 같은 의미가 나온다. 실제 코루틴에서 사용하는 suspend 함수 역시 코루틴이 중지 되었다가 재개될 수 있는 지점이 된다. 이를 가리켜 <code>suspension point</code>라고 부른다. 여기서 핵심은 <strong>될 수 있는</strong> 이다. suspend 함수를 호출한다고 해서 무조건 중지되는 것이 아니다. 중지가 될 수도 있고, 중지가 되지 않을 수도 있다는 의미이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">lec0801</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Unit <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n    launch <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    launch <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">c</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"A\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"B\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">c</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"C\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>첫 번째 코루틴에서는 suspend 함수인 <code>a()</code>와 <code>b()</code>를 각각 호출하고 있어서, <code>a()</code>가 호출된 다음 중지되어 두 번째 코루틴이 실행될 것 같지만, 사실은 suspend 함수를 호출하더라도 반드시 중지되는 것은 아니기에 A와 B가 먼저 출력되고 나중에 C가 출력되게 된다.</p>\n<p>그렇다면 이런 suspend 함수는 어떻게 활용할 수 있을까? 연쇄적인 API를 호출해야 하는 상황이라고 생각해보자. 첫 번째 API 호출에서 나온 결과를 두 번째 API 호출 때 사용해야 한다. 그렇다면, 우리는 다음과 같이 코드를 작성할 수 있을 것이다. 원래 <code>Thread.sleep()</code>은 non blocking 상황에서 스레드 자체를 막을 수 있어 사용하면 안되지만, 1초간의 대기를 가정하기 위해 작성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">lec0802</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Unit <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> result1 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">call1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">val</span> result2 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">call2</span><span class=\"token punctuation\">(</span>result1<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span>result2<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">call1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">{</span>\n    Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">100</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">call2</span><span class=\"token punctuation\">(</span>num<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">{</span>\n    Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> num <span class=\"token operator\">*</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>우리는 <code>async</code>와 <code>Deferred</code>를 활용해 콜백을 활용하지 않고 코드를 작성했다. 하지만, <code>runBlocking</code> 입장에서 result1과 result2의 타입이 <code>Deferred</code>이기에 <code>Deffered</code>에 의존적인 코드가 되는 것은 아쉽다. <code>Deferred</code> 대신에 <code>CompletableFuture</code> 또는 <code>Reactor</code>와 같은 다른 비동기 라이브러리 코드로 갈아 끼워야 할 수도 있다. 이럴 때 우리는 suspend 함수를 활용할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">lec0802</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Unit <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> result1 <span class=\"token operator\">=</span> <span class=\"token function\">call1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> result2 <span class=\"token operator\">=</span> <span class=\"token function\">call2</span><span class=\"token punctuation\">(</span>result1<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span>result2<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">call1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">CoroutineScope</span><span class=\"token punctuation\">(</span>Dispatchers<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">async</span> <span class=\"token punctuation\">{</span>\n        Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token number\">100</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">call2</span><span class=\"token punctuation\">(</span>num<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> CompletableFuture<span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span> <span class=\"token punctuation\">{</span>\n        Thread<span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        num <span class=\"token operator\">*</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>call1함수와 call2함수를 <code>suspend fun</code>으로 변경해 이 안에서 어떤 비동기 구현체 라이브러리를 사용하던지 해당 함수의 선택으로 남겨둔 것이다. <code>CompletabueFuture</code>에 사용한 <code>await()</code> 함수 역시 코루틴에서 만들어 둔 suspend 함수이다. 코루틴에는 다양한 비동기 라이브러리와 변환 코드를 제공한다.</p>\n<p>그렇다면 코루틴 라이브러리에서 제공하는 suspend 함수를 몇 가지 살펴보자. 첫 번째 함수는 <code>coroutineScope</code>이다. 이 함수도 <code>launch</code>나 <code>async</code>처럼 새로운 코루틴을 만들지만, 주어진 함수 블록이 바로 실행되는 특징을 갖고 있다. 또한, 새로 생긴 코루틴과 자식 코루틴들이 모두 완료된 이후, 반환된다. coroutineScope으로 만든 코루틴은 이전 코루틴의 자식 코루틴이 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">calculateResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> coroutineScope <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> num1 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token number\">10</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">val</span> num2 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token number\">20</span>\n    <span class=\"token punctuation\">}</span>\n\n    num1<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> num2<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>다음으로 살펴볼 함수는 <code>withContext</code>이다. <code>withContext</code> 역시 주어진 코드 블록이 즉시 호출되며 새로운 코루틴이 만들어지고, 이 코루틴이 완전히 종료되어야 반환된다. 즉 기본적으로는 <code>coroutineScope</code>과 같다. 하지만 <code>withContext</code>를 사용할 때 context에 변화를 줄 수 있어 다음과 같이 Dispatcher를 바꿔 사용할 때 활용해볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">calculateResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token function\">withContext</span><span class=\"token punctuation\">(</span>Dispatchers<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> num1 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token number\">10</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">val</span> num2 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token number\">20</span>\n    <span class=\"token punctuation\">}</span>\n\n    num1<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> num2<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>마지막으로 <code>withTimeout</code>과 <code>withTimeoutOrNull</code>이 있다. 이 함수들 역시 coroutineScope과 유사하지만 주어진 함수 블록이 시간 내에 완료되어야 한다는 차이점이 있다. 주어진 시간 안에 코루틴이 완료되지 않으면 <code>withTimeout</code>은 <code>TimeoutCancellationException</code>을 던지게 되고, <code>withTimeoutOrNull</code>은 <code>null</code>을 반환하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> result<span class=\"token operator\">:</span> Int<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token function\">withTimeoutOrNull</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000L</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_500L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token number\">10</span> <span class=\"token operator\">+</span> <span class=\"token number\">20</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">printWithThread</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>코루틴과 Continuation</h2>\n<p>이번에는 코루틴이 어떤 원리로 동작하고 있는지 구체적으로 알아보자. 코루틴의 동작 원리를 알아보기 위한 예제를 준비했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> UserService <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userProfileRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserProfileRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userImageRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserImageRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"유저를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data</span> <span class=\"token keyword\">class</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">val</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">val</span> image<span class=\"token operator\">:</span> Image<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> UserProfileRepository <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Profile <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">Profile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> Profile\n\n<span class=\"token keyword\">class</span> UserImageRepository <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token operator\">:</span> Profile<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Image <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> Image</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>우리는 중단함수인 <code>findUser</code>가 어떻게 구현되는지 알아볼 것이다. 가장 먼저 findUser에서 중단 될 수 있는 지점을 확인해보자. suspend 함수의 의미는 “중단이 될 수 있다”는 의미이기에, suspend 함수를 호출하는 두 곳이 우리의 중단될 수 있는 지점이 된다. 이 지점을 경계로 메소드를 나누면 총 3단계로 나누어진다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 0단계 - 초기 시작</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">// 1단계 - 1차 중단 후 재시작</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">// 2단계 - 2차 중단 후 재시작</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이제 우리는 이 각 단계를 라벨로 표시할 것이다. 라벨을 표시하기 위해, 라벨 정보를 갖고있는 객체를 하나 만들어야 한다. 이 객체는 우선 인터페이스로 만들고, findUser 메소드 안에서 익명 클래스로 라벨을 갖고 있게 처리하겠다. 그럼 다음과 같은 코드로 변경된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> Continuation <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// state machine의 약자, 라벨을 기준으로 상태를 관리</span>\n    <span class=\"token keyword\">val</span> sm <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> Continuation <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> label <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\">// 익명 클래스를 만들어 라벨을 갖게 만든다. 하므로 sm이라 이름 지었다.</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token number\">2</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이렇게까지 코드가 변경되면, 에러가 발생하기 시작한다. 가장 먼저 눈에 띄는 에러는 1번 라벨과 2번 라벨에서 profile, image를 가져올 수 없다는 에러이다. 이를 해결하기 위해 우리가 만들었던 sm에 profile과 image를 갖고 있게 하자. 그리고 해당 데이터가 필요한 순간에 sm에서 데이터를 꺼내 사용하게 변경하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// state machine의 약자, 라벨을 기준으로 상태를 관리</span>\n    <span class=\"token keyword\">val</span> sm <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> Continuation <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> label <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">var</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">var</span> image<span class=\"token operator\">:</span> Image<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token number\">2</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>다음으로 이제 sm에 이 데이터를 갖고 있을 수 있게 처리해주어야 한다. 또한, 현재는 라벨이 0으로 고정되어 있으므로 중단 지점 직전에 label을 하나씩 올려주도록 하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> sm <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> Continuation <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> label <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">var</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">var</span> image<span class=\"token operator\">:</span> Image<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n            <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>profile <span class=\"token operator\">=</span> profile\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n            <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> image\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token number\">2</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">.</span>image<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>그러면 어떻게 1번 라벨과 2번 라벨이 호출되게 할 수 있을까? 현재는 <code>findUser</code>가 호출되면, sm 이라는 변수가 만들어지며 0번 라벨을 갖게 되고, <code>userProfileRepository.findProfile()</code>를 호출 직전 1번 라벨로 변경되긴 하지만, 그대로 함수가 종료되어 버린다. 이를 해결하기 위해, <code>suspend</code> 함수는 가장 마지막 매개변수로 <code>Continuation</code>을 받도록 변경할 것이다. 우리가 살펴보고 있는 <code>findUser</code> 중단 함수도 마찬가지이고, <code>findUser</code>에서 사용하고 있는 <code>findProfile</code>이나 <code>findImage</code>도 마찬가지이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> UserImageRepository <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token operator\">:</span> Profile<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Image <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> UserProfileRepository <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Profile <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">Profile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> UserService <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userProfileRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserProfileRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userImageRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserImageRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> sm <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> Continuation <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> label <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n            <span class=\"token keyword\">var</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n            <span class=\"token keyword\">var</span> image<span class=\"token operator\">:</span> Image<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n            <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>profile <span class=\"token operator\">=</span> profile\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n            <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">)</span>\n            sm<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> image\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token number\">2</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">.</span>image<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>그리고 이제 <code>Continuation</code>에 <code>resumeWith(data: Any?)</code>라는 함수를 하나 만들고, findUser에서 익명 클래스로 만든 sm에 <code>resumeWith</code>를 오버라이드 하도록 한다. 오버라이드된 <code>resumeWith</code>에서는 다시 한 번 findUser를 호출할 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> Continuation <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> UserService <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userProfileRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserProfileRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userImageRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserImageRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token function\">FindUserContinuation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> Continuation <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> label <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">var</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">var</span> image<span class=\"token operator\">:</span> Image<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> sm <span class=\"token operator\">=</span> continuation <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> FindUserContinuation <span class=\"token operator\">?:</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> <span class=\"token function\">FindUserContinuation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">override</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                        profile <span class=\"token operator\">=</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">as</span> Profile\n                        label <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n                    <span class=\"token punctuation\">}</span>\n\n                    <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                        image <span class=\"token operator\">=</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">as</span> Image\n                        label <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n                sm<span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n                <span class=\"token keyword\">val</span> profile <span class=\"token operator\">=</span> userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">)</span>\n                sm<span class=\"token punctuation\">.</span>profile <span class=\"token operator\">=</span> profile\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다\"</span></span><span class=\"token punctuation\">)</span>\n                sm<span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n                <span class=\"token keyword\">val</span> image <span class=\"token operator\">=</span> userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">)</span>\n                sm<span class=\"token punctuation\">.</span>image <span class=\"token operator\">=</span> image\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token number\">2</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">.</span>image<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>자 그럼 이제 우리가 findUser에서 호출하는 또 다른 suspend 함수인 findProfile과 findImage에 넘겨준 이 Continuation 객체를 이용해 resumeWith를 호출한다면, 다음 라벨 영역의 코드가 호출되게 만들 수 있을 것이다. 이렇게 동작하기 위해서, findUser가 호출 될 때마다 sm을 새로 만들어주지 않고, 들어온 Continuation 객체의 타입에 따라 새로운 Continuation 객체를 만들도록 수정한다. 또한, Continuation의 resumeWith를 override한 함수에서 라벨과 데이터를 넣어주도록 수정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">package</span> me<span class=\"token punctuation\">.</span>sungbin<span class=\"token punctuation\">.</span>coroutine\n\n<span class=\"token keyword\">import</span> kotlinx<span class=\"token punctuation\">.</span>coroutines<span class=\"token punctuation\">.</span>delay\n\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> userService <span class=\"token operator\">=</span> <span class=\"token function\">UserService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span>userService<span class=\"token punctuation\">.</span><span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">interface</span> Continuation <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> UserService <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userProfileRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserProfileRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> userImageRepository <span class=\"token operator\">=</span> <span class=\"token function\">UserImageRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token function\">FindUserContinuation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> Continuation <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> label <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">var</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">var</span> image<span class=\"token operator\">:</span> Image<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDto <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> sm <span class=\"token operator\">=</span> continuation <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> FindUserContinuation <span class=\"token operator\">?:</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> <span class=\"token function\">FindUserContinuation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">override</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                        profile <span class=\"token operator\">=</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">as</span> Profile\n                        label <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n                    <span class=\"token punctuation\">}</span>\n\n                    <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                        image <span class=\"token operator\">=</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">as</span> Image\n                        label <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token number\">0</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// 0단계 - 초기 시작</span>\n                <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"프로필을 가져오겠습니다.\"</span></span><span class=\"token punctuation\">)</span>\n                userProfileRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token number\">1</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// 1단계 - 1차 중단 후 재시작</span>\n                <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"이미지를 가져오겠습니다.\"</span></span><span class=\"token punctuation\">)</span>\n                userImageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 2단계 - 2차 중단 후 재시작</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>profile<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">.</span>image<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data</span> <span class=\"token keyword\">class</span> <span class=\"token function\">UserDto</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">val</span> profile<span class=\"token operator\">:</span> Profile<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">val</span> image<span class=\"token operator\">:</span> Image<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> UserProfileRepository <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findProfile</span><span class=\"token punctuation\">(</span>userId<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n        continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">Profile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> Profile\n\n<span class=\"token keyword\">class</span> Image\n\n<span class=\"token keyword\">class</span> UserImageRepository <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">findImage</span><span class=\"token punctuation\">(</span>profile<span class=\"token operator\">:</span> Profile<span class=\"token punctuation\">,</span> continuation<span class=\"token operator\">:</span> Continuation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span>\n        continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이렇게 되면, 우리가 그림에서 살펴보았던 것처럼, Continuation 을 통해 최초 호출인지 아니면 callback 호출인지를 구분할 수 있게 되고, Continuation 의 구현 클래스에서 라벨과 전달할 데이터 등을 관리할 수 있게 된다. 이렇게 코루틴의 내부 동작 원리를 살펴보았다. 실제 우리가 최초 작성했던 간단한 findUser 함수는 컴파일을 하게 되면, 우리가 만들어봤던 Continuation을 사용한 Continuation Passing Style (CPS)로 변하게 된다. 실제 코루틴에서 사용되는 Continuation 인터페이스와 주요 함수는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> Continuation<span class=\"token operator\">&lt;</span><span class=\"token keyword\">in</span> T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">val</span> context<span class=\"token operator\">:</span> CoroutineContext\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">resumeWith</span><span class=\"token punctuation\">(</span>result<span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>","fields":{"slug":"/coroutine-코루틴의-구성-요소와-원리/"},"timeToRead":13,"frontmatter":{"title":"[코루틴] 코루틴의 구성 요소와 원리","tags":["kotlin"],"date":"2026-02-28T14:04:27.000Z","image":{"publicURL":"/static/04341d4252ddede34778002280a915f7/banner.png"},"series":"코루틴"}}},"pageContext":{"id":"9278103d-270c-5d9a-8ef0-77c4b0209efb"}},
    "staticQueryHashes": ["2580406332","3810308631"]}